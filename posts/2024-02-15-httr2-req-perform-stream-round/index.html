<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Romain FranÃ§ois">
<meta name="dcterms.date" content="2024-02-15">

<title>tadaâ¬¢science - ğŸ§¢ httr2::req_perform_stream(round = ) âš¾ï¸</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">tada<span style="color:pink; font-size: 120%">â¬¢</span>science</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">ğŸ§¢ httr2::req_perform_stream(round = ) âš¾ï¸</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">package</div>
                <div class="quarto-category">httr2</div>
                <div class="quarto-category">R</div>
                <div class="quarto-category">emoji</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author">Romain FranÃ§ois </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://tada.science">
              tadaâ¬¢science
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 15, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#in-da-beginning-there-was-emoji" id="toc-in-da-beginning-there-was-emoji" class="nav-link active" data-scroll-target="#in-da-beginning-there-was-emoji">In da beginning, there was emoji</a></li>
  <li><a href="#golem-poem" id="toc-golem-poem" class="nav-link" data-scroll-target="#golem-poem">golem poem</a></li>
  <li><a href="#fixing-mlversechattr" id="toc-fixing-mlversechattr" class="nav-link" data-scroll-target="#fixing-mlversechattr">Fixing mlverse/chattr</a></li>
  <li><a href="#fixing-r-libhttr2" id="toc-fixing-r-libhttr2" class="nav-link" data-scroll-target="#fixing-r-libhttr2">Fixing r-lib/httr2</a></li>
  <li><a href="#fixing-mlversechattr-take-2" id="toc-fixing-mlversechattr-take-2" class="nav-link" data-scroll-target="#fixing-mlversechattr-take-2">Fixing mlverse/chattr, take 2</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p><a href="https://httr2.r-lib.org"><img src="https://httr2.r-lib.org/logo.png" align="left" height="138" style="margin: 10px"></a> httr2 is an amazing ğŸ“¦ from the <code>r-lib</code> team. Built on top of the strong foundations of <code>curl</code>, experience from the previous incarnation with <code>httr</code> and tidy principles and design, <code>httr2</code> is an easy goto for anything api related.</p>
<p>But â€¦ I found a bug ğŸª², or letâ€™s call it a missed opportunity ğŸ¤“. TL;DR <a href="https://github.com/r-lib/httr2/pull/437">it was fixed</a>. Letâ€™s rewind.</p>
<section id="in-da-beginning-there-was-emoji" class="level2">
<h2 class="anchored" data-anchor-id="in-da-beginning-there-was-emoji">In da beginning, there was emoji</h2>
<p>ğŸ‰ aka <code>:tada:</code> is the best emoji, this is not open for debate ğŸ˜‚.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>(tada <span class="ot">&lt;-</span> emo<span class="sc">::</span><span class="fu">ji</span>(<span class="st">"tada"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ğŸ‰ </code></pre>
</div>
</div>
<p>Letâ€™s dissect it with the help of ğŸ“¦ <a href="https://github.com/ThinkR-open/utf8splain"><code>utf8splain</code></a> and <a href="https://github.com/ThinkR-open/uni"><code>uni</code></a> I totally forgot about. <code>tada</code> is a single code point emoji <code>U+1F389</code> aka <code>"\U1F389"</code> in R:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"\U1F389"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>ğŸ‰</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>dplyr<span class="sc">::</span><span class="fu">filter</span>(uni<span class="sc">::</span>code, rune <span class="sc">==</span> <span class="st">"U+1F389"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 Ã— 7
      id rune    description     block                 countries languages type 
   &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;           &lt;chr&gt;                 &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;
1 127881 U+1F389 " Party Popper" miscellaneous-symbolâ€¦ &lt;NA&gt;      &lt;NA&gt;      &lt;NA&gt; </code></pre>
</div>
</div>
<p>In utf-8, i.e.&nbsp;the encoding to rule them all, ğŸ‰ is encoded with 4 bytes that follow the convention explained in <a href="https://en.wikipedia.org/wiki/UTF-8#Encoding">the UTF-8 wikipedia page</a>. <code>11110000</code> : starts with <code>11110</code> to indicate it is a 4 bytes encoded code point (or rune ğŸ€„ï¸), followed by 3 continuation bytes that start with <code>10</code> : <code>10011111, 10001110, 10001001</code>.</p>
<p>(<em>I still donâ€™t know how to reveal the ansi escape codes in quarto, so using a screenshot instead so that you have colors ğŸŒˆ).</em></p>
<div class="quarto-figure quarto-figure-left">
<figure class="figure">
<p><img src="tada.png" class="img-fluid quarto-figure quarto-figure-left figure-img"></p>
</figure>
</div>
<p>Just like ğŸ‰, many characters are encoded using more than on byte in utf-8 and other encodings.</p>
</section>
<section id="golem-poem" class="level2">
<h2 class="anchored" data-anchor-id="golem-poem">golem poem</h2>
<p>While weâ€™re in <a href="https://thinkr.fr">ThinkR</a> realm (<code>uni</code> and <code>utf8splain</code>) are weekend ğŸ“¦ we developed when I was working with them ğŸ’œ, letâ€™s look at what started this side quest of fixing a ğŸ in <code>httr2</code>. In the <a href="https://tada.science/posts/2024-02-02-tada-verse-poems/">tada::verse()</a> post I introduced a function to compose ğŸ“¦ poems with ChatGPT via the <a href="https://github.com/mlverse/chattr">mlverse/chattr</a> package, and was annoyed that the function would not work to write a <a href="https://thinkr-open.github.io/golem/"><code>golem</code></a> poem.</p>
<pre><code>&gt; chattr::chattr("Can you write a poem about the R package called 'golem'. Please add a bunch of emojis.")
Sure! Here's a poem about the R package 'golem' with a bunch of emojis:

Error in `discard()`:
â„¹ In index: 1.
Caused by error:
! `.p()` must return a single `TRUE` or `FALSE`, not `NA`.
Run `rlang::last_trace()` to see where the error occurred.
Warning messages:
1: In strsplit(., "data: ") :
  unable to translate 'data: {"id":"chatcmpl-8nsIIxlfPHfY8BhhuUu7NFsIO57AC","object":"chat.completion.chunk","created":1706897470,"model":"gpt-3.5-turbo-0613","system_fingerprint":null,"choices":[{"index":0,"delta":{"role":"assistant","content":""},"logprobs":null,"finish_re...' to a wide string
2: In strsplit(., "data: ") : input string 1 is invalid</code></pre>
<p>That was embarrassing and curbed my enthusiasm about sharing the poem with the team. I still did, but I had to use the normal ChatGPT app like a human instead of the api ğŸ˜¥.</p>
</section>
<section id="fixing-mlversechattr" class="level2">
<h2 class="anchored" data-anchor-id="fixing-mlversechattr">Fixing mlverse/chattr</h2>
<p><a href="https://github.com/mlverse/chattr">mlerse/chattr</a> is not the only R ğŸ“¦ that can speak to <code>ChatGPT</code> and I successfully used <a href="https://irudnyts.github.io/openai/">irudnyts/openai</a> for another similar quest with the <code>valentine</code> package that writes <a href="https://tada.science/posts/2024-02-14-roses-are-red/">roses are red â€¦</a> poems about packages. This does work, e.g.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>valentine<span class="sc">::</span><span class="fu">roses</span>(<span class="st">"golem"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Roses are red, ğŸŒ¹
Golem is neat, ğŸ’«
With R package power, ğŸ’ª
Coding dreams complete! âœ¨</code></pre>
</div>
</div>
<p>The advantage of <code>mlverse/chattr</code> though is that is uses streaming to get tokens faster rather than wait for the whole poem to be composed.</p>
<p>So naturally, I went for a dive on how <code>mlverse/chattr</code> works, using <a href="https://tada.science/posts/2024-02-04-snitch/">snitch</a> to get some understanding of its implementation, and sending <a href="https://github.com/mlverse/chattr/issues/63">a bottle in the issues</a> in case the <code>chattr</code> team wanted to spare my quest.</p>
<p>I sent a first clunky <a href="https://github.com/mlverse/chattr/pull/64">pull request</a> that did the job, while looking kind of ugly and hacky. When that happens, thatâ€™s usually a good sign that this is a solution to the wrong problem, so I abandonned that PR and decided to go earlier in the ğŸ“¦ chain and look at <a href="https://httr2.r-lib.org">r-lib/httr2</a> because <code>chattr</code> uses <code>httr2::req_perform_stream()</code> to â€¦ process the stream.</p>
<p>The stream from ChatGPT is processed by fixed-size chunks of bytes, and so the problem was that on occasions, these chunks cut an emoji in the middle, which causes issues down the line:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>tad <span class="ot">&lt;-</span> <span class="fu">charToRaw</span>(tada)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>tad</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] f0 9f 8e</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rawToChar</span>(tad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "\xf0\x9f\x8e"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nchar</span>(tad)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2 2 2</code></pre>
</div>
</div>
<p>This confused other parts of the <code>mlverse/chattr</code> codebase.</p>
</section>
<section id="fixing-r-libhttr2" class="level2">
<h2 class="anchored" data-anchor-id="fixing-r-libhttr2">Fixing r-lib/httr2</h2>
<p>Now that this was reframed as a missed <code>r-lib/httr2</code> opportunity, and I had been looking for an excuse to peep on how <code>httr2</code> works, I deep dived and opened a <a href="https://github.com/r-lib/httr2/pull/437">pull request</a> last week. Hadley started to review it the next day and we ğŸ“ on it and iterated a few times until we were happy about it.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="pr.png" class="img-fluid quarto-figure quarto-figure-center figure-img"></p>
</figure>
</div>
<p>It is now merged, and so will be released as part of the next <code>httr2</code> release, but you can take it for a spin with <code>pak::pak("r-lib/httr2")</code>.</p>
<p>My initial proposal was to add a <code>req_perform_stream_lines()</code>, based on the idea that if we know the stream is text encoded in utf-8, instead of streaming all the bytes, and taking the risk that chunks might cut emojis or other character mid rune, we can buffer the bytes and process line by line.</p>
<p>This kind of worked, but we ended up having the two sister functions <code>req_perform_stream()</code> and <code>req_perform_stream_lines()</code> that shared a lot of logic but were different. Something was off.</p>
<p>We continued to iterate, and Hadley has been as usual generous with reviewing and improving the pull request. Hadley even contributed the tests that allowed us to ğŸƒâ€â™‚ï¸ the last kilometer ğŸ’š.</p>
<p>We settled on adding the extra argument <code>round=</code> to the <code>req_perform_stream()</code> function, so that instead of processing fixed-size chunks of bytes, the callback function could receive a truncated sequence of bytes.</p>
<p>Here is the updated documentation for <code>req_perform_stream()</code> :</p>
<p><img src="round.png" class="img-fluid"></p>
<p>The default behavior remains <code>round = "byte"</code> so that the risk of the pull request being dispruptive is minimal, so by default the full chunk of <code>buffer_kb</code> kilobytes is sent to the <code>callback</code>.</p>
<p>The added value of the pull request though is that you can now <code>round = "line"</code> so that the stream is buffered and cut at the last newline character, a new line is a character that is encoded in a single byte, i.e.&nbsp;its utf-8 representation is the same as its ascii <code>00001010</code> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>utf8splain<span class="sc">::</span><span class="fu">runes</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>utf-8 encoded string with 1 runes

U+000A   0A   00001010    New Line (Nl) : line feed (lf) : end of line (eol) : LF</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>utf8splain<span class="sc">::</span><span class="fu">bytes</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 Ã— 4
     id byte  decimal binary  
  &lt;int&gt; &lt;raw&gt;   &lt;int&gt; &lt;chr&gt;   
1     1 0a         10 00001010</code></pre>
</div>
</div>
<p>We also contemplated on implementing <code>round = "utf8"</code> to round at the last valid utf-8 sequence, but we eventually arbitrated that itâ€™s probably not worth it at this stage.</p>
<p>But <code>round =</code> is flexible enough to accomodate for other ways of rounding, and is passed through the internal <code>httr2::as_round_function()</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>as_round_function <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">round =</span> <span class="fu">c</span>(<span class="st">"byte"</span>, <span class="st">"line"</span>),</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                              <span class="at">error_call =</span> <span class="fu">caller_env</span>()) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.function</span>(round)) {</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">check_function2</span>(round, <span class="at">args =</span> <span class="st">"bytes"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    round</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.character</span>(round)) {</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    round <span class="ot">&lt;-</span> <span class="fu">arg_match</span>(round, <span class="at">error_call =</span> error_call)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span>(round,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">byte =</span> <span class="cf">function</span>(bytes) <span class="fu">length</span>(bytes),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">line =</span> <span class="cf">function</span>(bytes) <span class="fu">which</span>(bytes <span class="sc">==</span> <span class="fu">charToRaw</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    cli<span class="sc">::</span><span class="fu">cli_abort</span>(</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">'{.arg round} must be "byte", "line" or a function.'</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">call =</span> error_call</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Iâ€™ll talk about <code>cli_abort()</code>, <code>arg_match()</code> and <code>error_call</code> some other day. Working on this pull request was great and I believe we end up with the right solution.</p>
</section>
<section id="fixing-mlversechattr-take-2" class="level2">
<h2 class="anchored" data-anchor-id="fixing-mlversechattr-take-2">Fixing mlverse/chattr, take 2</h2>
<p>With <code>req_perform_stream(round = "line")</code> it becomes much easier to fix the initial problem, so I could send a second <a href="https://github.com/mlverse/chattr/pull/65">pull request</a> there, and now with the dev version of <code>httr2</code> and the pull request of <code>chattr</code> we can finally enjoy the <code>golem</code> poem:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pak::pak("mlverse/chattr#65")</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>chattr<span class="sc">::</span><span class="fu">chattr_use</span>(<span class="st">"gpt35"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>â”€â”€ chattr </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>â€¢ Provider: Open AI - Chat Completions</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>â€¢ Path/URL: https://api.openai.com/v1/chat/completions</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>â€¢ Model: gpt-3.5-turbo</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>tada<span class="sc">::</span><span class="fu">verse</span>(<span class="st">"golem"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sure! Here's a poem about the R package 'golem' with a bunch of emojis:

ğŸŒŸ In the land of R, a package was born,
ğŸ”§ Its name was 'golem', a tool to adorn.
ğŸ—ï¸ With ğŸ§± and ğŸ—ï¸, it built apps with ease,
ğŸŒˆ Adding colors and interactivity, oh please!

ğŸ“¦ 'Golem' wrapped up shiny, like a gift,
ğŸ Making web apps with a magical lift.
ğŸŒ It brought the power of the web to R,
ğŸ–¥ï¸ Creating interfaces that would take you far.

ğŸ”® With 'golem', your app could be grand,
ğŸ¨ Customizing the UI with a wave of your hand.
ğŸ“Š Visualizations, charts, and graphs,
ğŸ“ All made possible with 'golem's' crafts.

ğŸ”’ Security was 'golem's' top priority,
ğŸ” Protecting your app with utmost sincerity.
ğŸ” Continuous integration, deployment made smooth,
ğŸš€ Launching your app with a confident groove.

ğŸŒŸ So, if you seek to build apps with flair,
ğŸ”§ 'Golem' is the package that's beyond compare.
ğŸ—ï¸ With its help, your dreams will come true,
ğŸŒˆ Creating web apps that will surely woo!</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>